# Phase 14: HIDA Core Architecture
# 飛騨アーキテクチャ本体

## 概要

Phase 14 は飛騨アーキテクチャの核心実装。
L1〜L5 の5層が常時ループし、名前を呼ぶと意識が ON になる。
LLM に頼らず、人間から学んで L4（記憶層）を育てる。

## 実行方法

```bash
python phase14_hida_core.py
```

PyBullet のシミュレーションウィンドウが開き、対話モードになる。

## 5層構造

```
L1: 身体層（Body）
    - センサー入力（視覚、聴覚、触覚）
    - モーター出力（移動、拾う、置く）

L2: クオリア層（Qualia）
    - 感覚の統合
    - 視覚情報、音声情報の処理

L3: 構造化層（Structure）
    - 予測と予測誤差
    - コマンド解析
    - 言語理解

L4: 記憶層（Memory）
    - 物体の知識（色、形、サイズ）
    - 位置記憶（last_seen, original_pos）
    - 成功率、経験
    - 学習した好み（verbs, responses, custom_actions）

L5: 意識層（Consciousness）
    - 5層の統合
    - 意識状態（IDLE, ALERT, ACTIVE, SEARCHING, HOLDING）
    - 予測誤差が閾値を超えると意識 ON
```

## 動作フロー

```
常時ループ（バックグラウンド）
  ↓
「飛騨」と呼ばれる
  ↓
L3: 予測誤差増大 → L5: 意識 ON
  ↓
「赤いボール持ってきて」
  ↓
L4: 記憶検索「赤いボール = 赤、丸い」
L2: 視覚で探す
L3: 予測誤差「あるはず → 見つけた」
  ↓
行動が自然に生まれる
  ↓
完了 → 待機
```

## 機能一覧

### 基本コマンド

| コマンド | 動作 |
|---------|------|
| 飛騨、赤いボール取って | 赤いボールを取ってくる |
| 飛騨、ボール取って | どの色か聞いてから取る |
| 飛騨、黄色とって | 黄色いボールを取る |
| 飛騨、ボール返して | どの色か聞いて初期位置に戻す |
| 飛騨、赤返して | 赤いボールを初期位置に戻す |
| 飛騨、全部取って | 全ボールを順番に取る |
| 飛騨、止まって | 行動を中断 |

### 学習機能

#### 応答を教える
```
飛騨、おはよう
→ 「どういう意味？」
→ 「応答を教える」
→ 「何と言えばいい？」
→ 「おはようございます」
→ 学習完了

次から:
飛騨、おはよう
→ 飛騨:「おはようございます」
```

#### 行動を教える
```
飛騨、ボール何個ある？
→ 「どういう意味？」
→ 「行動を教える」
→ 「何をすればいい？」
→ 「全部数える」
→ 学習完了

次から:
飛騨、ボール何個ある？
→ 飛騨:「ボールは3個あります」
```

#### 動詞を教える
```
飛騨、ゲットして
→ 「どういう意味？」
→ 「持ってくる」
→ 学習: ゲット → fetch

次から:
飛騨、赤いボールゲットして
→ 取りに行く
```

## L4 記憶の構造

```python
Memory:
    objects: {
        "赤いボール": {"color": "red", "shape": "sphere", "size": 0.2},
        "黄色いボール": {...},
        "青いボール": {...},
    }
    
    last_seen: {
        "赤いボール": {"position": [2.0, 1.0, 0.3], "time": 1234567890}
    }
    
    original_pos: {
        "赤いボール": [2.0, 1.0, 0.3]  # 初期位置（返す用）
    }
    
    success_rate: {
        "赤いボール": {"found": 5, "failed": 1}
    }
    
    experiences: [
        {"action": "deliver", "object": "赤いボール", "success": True, "time": ...}
    ]
    
    preferences: {
        "verbs": {"ゲット": "fetch"},
        "responses": {"おはよう": "おはようございます"},
        "custom_actions": {"ボール何個ある": "全部数える"}
    }
```

## action_queue（複数タスク）

```
「飛騨、赤いボールと黄色いボールと青いボール持ってきて」

→ action_queue に3件追加
→ 赤いボール → 完了
→ 黄色いボール → 完了
→ 青いボール → 完了
→ 全部終わった！
```

## 行動タイプ

| タイプ | 説明 |
|--------|------|
| search | 探す（見つけたら pick_up → deliver） |
| fetch | 取ってくる（search と同じ） |
| put_back | 初期位置に戻す |
| pick_up | 拾う |
| deliver | 届ける |

## シミュレーション

PyBullet を使用:
- 青い箱: ロボット（飛騨）
- 赤い球: 赤いボール [2, 1, 0.3]
- 黄色い球: 黄色いボール [-1, 2, 0.3]
- 青い球: 青いボール [1, -2, 0.3]

## Phase 13 との違い

| 項目 | Phase 13 | Phase 14 |
|------|----------|----------|
| 行動決定 | 辞書マッピング | L1〜L5 ループから生成 |
| 意識 | なし | ON/OFF 切替 |
| 記憶 | なし | 位置・初期位置・成功率・経験 |
| 学習 | なし | 人間から学習 |
| 本質 | リモコン | 意識エンジン |

## 技術的特徴

1. **LLM 不要**: ローカルで完結、外部 API 不要
2. **人間から学ぶ**: 質問 → 回答 → 記憶
3. **経験から学ぶ**: 成功/失敗を記録
4. **初期位置記憶**: put_back で元に戻せる
5. **色指定**: 正しいボールを拾う（近くの別色を拾わない）

## 今後の課題

1. **部分一致の改善**: 「何個ある？」と「何個ある」を同一視
2. **カスタム行動の拡張**: 「投げる」「隠す」など実装
3. **記憶の永続化**: JSON 保存
4. **障害物回避**: 物理的な経路計画

## Grok の評価（Phase 13 → 14 への転換点）

> 今の Phase 13 は「F1 エンジン積んでるけど手で押してる」
> 
> 本来の飛騨:
> L1 → L2 → L3 → L4 → L5
>       ↑               ↓
>       ←←←←←←←←←←←←
> 
> このループで体が動く
> 予測誤差 → 意識 ON → 行動が「生まれる」

Phase 14 でこれを実現した。



---

Created: 2025-12-13
Author: とまと + Claude
License: MIT
